// Module included in the following assemblies:
//
// * 

:_content-type: PROCEDURE

[id="terraform-iam-roles"]
= Creating account-wide IAM roles
Prior to creating a ROSA STS cluster, you must create the required account-wide roles and policies. See "Account-wide IAM role and policy reference" in the Additional resources for more information.

.Prerequisites
* You have an AWS account.
* You have installed the latest version of the ROSA command-line (CLI) (`rosa`).
* You have an offline OpenShift Cluster Manager token. This token can be generated in the Red Hat Hybrid Cloud Console link:https://console.redhat.com/[Red Hat Hybrid Cloud Console].
* You have installed Terraform. See the link:https://developer.hashicorp.com/terraform/downloads[Terraform page] for the latest version.

//.Open issue
//This example also creates the policies for the Operator roles. When you update the version, it also updates the Operator role policies.

.Procedure

. When running Terraform, you configure your infrastructure through variables. For more on Terraform variables, see link:https://developer.hashicorp.com/terraform/enterprise/workspaces/variables/managing-variables[Managing Variables] in the Terraform documentation. The following variables need to be defined to create your resources:
+ 
[%collapsible]
====
[source,terminal]
----
variable "ocm_environment" {
  type    = string
  default = "production"
}

variable "openshift_version" {
  type = string
  default = ""
}

variable "account_role_prefix" {
  type    = string
  default = ""
}

variable "token" {
  type = string
}

variable "url" {
  type        = string
  description = "Provide OCM environment by setting a value to url"
 default     = "https://api.openshift.com"
}

variable "path" {
  description = "(Optional) The arn path for the account/operator roles as well as their policies."
  type        = string
  default     = null
}

variable "tags" {
  description = "List of AWS resource tags to apply."
  type        = map(string)
  default     = null
}
----
====
+
Run the following commands to export your variables. Provide your values in lieu of the brackets. Any values declared in your `variables.tf` file are the default values if you do not export a superseding value.
+
* This variable should be your full link:https://console.redhat.com/openshift/token[Openshift Cluster Manager offline token] that you generated in the prerequisites. 
+
[source,terminal]
----
export TF_VAR_token=<ocm_offline_token>
----
+
* This value should be the prefix for your Operator role.
+
[source,terminal]
----
export TF_operator_role_prefix=<prefix_name>
----
+
* This value should always point to `\https://api.openshift.com`.
+
[source,terminal]
----
export TF_VAR_url=https://api.openshift.com
----
+
* *Optional:* You can set the desired OpenShift version with this variable. The default is available from the ROSA CLI with `rosa list version |grep yes`. The OpenShift version should be in the form of x.y, for example 4.13.
+
[source,terminal]
----
export TF_VAR_openshift_version=<choose_openshift_version>
----
+
* *Optional:* If you want to set specific AWS tags for your account roles, you can use this variable to declare those tags.
+
[source,terminal]
----
export TF_VAR_tags=<aws_resource_tags> (Optional)
----
+

. In your local copy of the `account-roles` folder, run the following command:
+
[source,terminal]
----
terraform init
----
+
Running this command accesses all the necessary provider information to apply your Terraform plan.
. *Optional:* Run the `plan` command to ensure that your Terraform files build correctly without errors. This is not required to apply your Terraform plan.
+
[source,terminal]
----
terraform plan -out account-roles.tfplan
----
+
. Run the apply command to create your account roles.
+
[NOTE]
====
If you did not run the `plan` command, you can simply just `apply` without specifying a file.
====
+

+
[source,terminal]
----
terraform apply <"account-roles.tfplan">
----
+
. Terraform applies the plan and creates the account roles. You will see a prompt to confirm you want to create your resources. Enter `yes`, then the process will complete with your resources.

.Verification
. In the `rosa` CLI, run the following command to verify that the account roles are created:
+
[source,terminal]
----
rosa list account-roles
----
+
. You see your roles when the command finishes.
+
[source,terminal]
----
I: Fetching account roles
ROLE NAME                           ROLE TYPE      ROLE ARN                                                    OPENSHIFT VERSION  AWS Managed
ManagedOpenShift-ControlPlane-Role  Control plane  arn:aws:iam::XXXXX:role/ManagedOpenShift-ControlPlane-Role  4.13               No
ManagedOpenShift-Installer-Role     Installer      arn:aws:iam::XXXXX:role/ManagedOpenShift-Installer-Role     4.13               No
ManagedOpenShift-Support-Role       Support        arn:aws:iam::XXXXX:role/ManagedOpenShift-Support-Role       4.13               No
ManagedOpenShift-Worker-Role        Worker         arn:aws:iam::XXXXX:role/ManagedOpenShift-Worker-Role        4.13               No
----

.Resource clean up
After you are done with the resources you created, you should not delete them manually, but instead, use the destroy command. Run the following to delete all of your created resources:

[source,terminal]
----
terraform destroy
----

After the command is complete, your resources are deleted.

[NOTE]
====
If you manually delete a resource, you create unresolvable issues within your environment.
====