// Module included in the following assemblies:
//
// 

:_content-type: PROCEDURE

[id="terraform-machine-pools"]
= Creating a machine pool for an existing OpenShift cluster
This Terraform example creates a new machine pool for an existing ROSA cluster which allows users to add different machine types to the cluster.

.Prerequisites
* You have an AWS account.
* You have installed the latest version of the ROSA command-line (CLI) (`rosa`).
* You have an offline OpenShift Cluster Manager token. This token can be generated in the Red Hat Hybrid Cloud Console link:https://console.redhat.com/[Red Hat Hybrid Cloud Console].
* You have installed Terraform. See the link:https://developer.hashicorp.com/terraform/downloads[Terraform page] for the latest version.
* You already created an OpenShift Cluster Manager cluster.

.Procedure

. When running Terraform, you configure your infrastructure through variables. For more on Terraform variables, see link:https://developer.hashicorp.com/terraform/enterprise/workspaces/variables/managing-variables[Managing Variables] in the Terraform documentation. The following variables need to be defined to create your resources:
+
[NOTE]
====
If you exported these variables in your current command-line session when running the account-roles Terraform example, you do not need to export them again.
====
+ 
[%collapsible]
====
[source,terminal]
----
variable "token" {
  type = string
}

variable "url" {
  type        = string
  description = "Provide OCM environment by setting a value to url"
  default     = "https://api.openshift.com"
}

variable "cluster_id" {
  description = "The ID of the cluster which the machine pool is created for."
  type        = string
}

variable "name" {
  description = "The machine pool name."
  type        = string
}

variable "machine_type" {
  description = "The AWS instance type that used for the instances creation ."
  type        = string
}

variable "replicas" {
  description = "The amount of the machine created in this machine pool."
  type        = number
  default     = null
}

variable "autoscaling_enabled" {
  description = "Enables autoscaling. This variable requires you to set a maximum and minimum replicas range using the `max_replicas` and `min_replicas` variables."
  type        = string
  default     = "false"
}

variable "min_replicas" {
  description = "The minimum number of replicas for autoscaling."
  type        = number
  default     = null
}

variable "max_replicas" {
  description = "The maximum number of replicas not exceeded by the autoscaling functionality."
  type        = number
  default     = null
}

variable "labels" {
  description = "Labels for the machine pool. Format should be a comma-separated list of 'key = value'. This list will overwrite any modifications made to node labels on an ongoing basis."
  type        = map(string)
  default     = null    
}
----
====
+
Run the following commands to export your variables. Provide your values in lieu of the brackets. Any values declared in your `variables.tf` file are the default values if you do not export a superseding value.
+
* This variable should be your full link:https://console.redhat.com/openshift/token[Openshift Cluster Manager offline token] that you generated in the prerequisites. 
+
[source,terminal]
----
export TF_VAR_token=<ocm_offline_token>
----
+
* This value should always point to `\https://api.openshift.com`.
+
[source,terminal]
----
export TF_VAR_url=https://api.openshift.com
----
+
* The machine pool cluster ID can be found in the `rosa` CLI with the command `rosa list cluster`.
+
[source,terminal]
----
export TF_VAR_cluster_id=<cluster_id>
----
+
* This variable creates your machine pool name.
+
[source,terminal]
----
export TF_VAR_name=<name>
----
+
* This variable selects your AWS instance type.
+
[source,terminal]
----
export TF_VAR_machine_type=<machine_type>
----
+
* This variable determines the amount of the machine created.
+
[source,terminal]
----
export TF_VAR_replicas=<replica>
----
+

. In your local copy of the `create_machine_pool` folder, run the following command:
+
[source,terminal]
----
terraform init
----
+
Running this command accesses all the necessary provider information to apply your Terraform plan.
. *Optional:* Run the `plan` command to ensure that your Terraform files build correctly without errors. This is not required to apply your Terraform plan.
+
[source,terminal]
----
terraform plan -out machine-pool.tfplan
----
+
. Run the apply command to create the machine pool.
+
[NOTE]
====
If you did not run the `plan` command, you can simply just `apply` without specifying a file.
====
+

+
[source,terminal]
----
terraform apply <"machine-pool.tfplan">
----
+
. Terraform applies the plan and creates the machine pool. You will see a prompt to confirm you want to create your resources. Enter `yes`, then the process will complete with your resources.

.Verification
. In the `rosa` CLI, run the following command to verify that the machine pools are created:
+
[source,terminal]
----
rosa list machinepools -c <cluster_id>
----
+
. You see your machine pools when the command finishes.
                                                  
.Resource clean up
After you are done with the resources you created, you should not delete them manually, but instead, use the destroy command. Run the following to delete all of your created resources:

[source,terminal]
----
terraform destroy
----

After the command is complete, your resources are deleted.

[NOTE]
====
If you manually delete a resource, you create unresolvable issues within your environment.
====