// Module included in the following assemblies:
//
// 
= Google
Using Google as an identity provider allows any Google user to authenticate your server. You can limit authentication to members of a specific hosted domain with the `hosted-domain` configuration attribute.

.Prerequisites
* You created your account roles using Terraform.
* You created your cluster using Terraform. This cluster can either have a managed OIDC configuration or an unmanaged OIDC configuration.
* *Optional:* You have configured your Terraform.tfvars file. 

.Setting up your application in Google
You will need a client ID/secret of a registered link:https://console.cloud.google.com/projectselector2/apis/dashboard?pli=1&supportedpurview=project[Google project]. 

The project must be configured with a redirect URL of `https://oauth-openshift.apps.<cluster-name>.<cluster-domain>/oauth2callback/<idp-provider-name>`. For example: `https://oauth-openshift.apps.openshift-cluster.example.com/oauth2callback/Google`.

[NOTE]
====
`<idp-provider-name>` is case-sensitive. See the link:https://github.com/terraform-redhat/terraform-provider-rhcs/blob/v1.3.0-prerelease.2/examples/create_identity_provider/github/main.tf#L37[Terraform pages] for more information on names.
====

.Procedure

. When running Terraform, you configure your infrastructure through variables. For more on Terraform variables, see link:https://developer.hashicorp.com/terraform/enterprise/workspaces/variables/managing-variables[Managing Variables] in the Terraform documentation. Create a `terraform.tfvars` file in this directory or add the following items to your existing `*.tfvars` file. You can also export the variables with the following commands:
+ 
[%collapsible]
====
[source,terminal]
----
variable "token" {
  type        = string
  description = "OCM token - You can get it here: https://console.redhat.com/openshift/token"
}

variable "cluster_id" {
  type        = string
  description = "The OCP cluster ID"
}

variable "url" {
  type        = string
  description = "Provide OCM environment by setting a value to url"
  default     = "https://api.openshift.com"
}

# IDP Variables
variable "google_client_id" {
  type        = string
  description = "Google client id"
}
variable "google_client_secret" {
  type        = string
  description = "Google client secret"
}
variable "google_hosted_domain" {
  type        = string
  description = "Restrict users to a Google Apps domain."
}
----
====
+
Run the following commands to export your variables. Provide your values in lieu of the brackets. Any values declared in your `variables.tf` file are the default values if you do not export a superseding value.
+
* This value is the generated Google client secret to validate your account. It can be found in the settings of your Google account. 
+
[source,terminal]
----
export TF_VAR_google_client_secret=<google_client_secret>
----
+
* This value is your Google client ID. It can be found in the settings of your Google account. 
+
[source,terminal]
----
export TF_VAR_google_client_id=<client_id>
----
+
* This value is your Google hosted domain that was generated in the previous step. 
+
[source,terminal]
----
export TF_VAR_google_hosted_domain='["<google_hosted_domain>"]'
----
+
* This variable should be your full link:https://console.redhat.com/openshift/token[Openshift Cluster Manager offline token] that you generated in the prerequisites. 
+
[source,terminal]
----
export TF_VAR_token=<ocm_offline_token>
----
+
* This value should always point to `\https://api.openshift.com`.
+
[source,terminal]
----
export TF_VAR_url=<ocm_url>
----
+
* The ID of the cluster for which you are creating the identity provider. This ID can be found in the `rosa` command-line interface (CLI) with the command `rosa list cluster`.
+
[source,terminal]
----
export TF_VAR_cluster_id=<cluster_id>
----
+

. In your local copy of the `google` folder, run the following command:
+
[source,terminal]
----
terraform init
----
+
Running this command accesses all the necessary provider information to apply your Terraform plan.
. *Optional:* Run the `plan` command to ensure that your Terraform files build correctly without errors. This is not required to apply your Terraform plan.
+
[source,terminal]
----
terraform plan -out google.tfplan
----
+
. Run the apply command to create your Google identity provider.
+
[NOTE]
====
If you did not run the `plan` command, you can simply just `apply` without specifying a file.
====
+

+
[source,terminal]
----
terraform apply <"google.tfplan">
----
+
. Terraform applies the plan and creates your identity provider using GitLab. You will see a prompt to confirm you want to create your resources. Enter `yes`, then the process will complete with your resources.
                                                  
.Resource clean up
After you are done with the resources you created, you should not delete them manually, but instead, use the destroy command. Run the following to delete all of your created resources:

[source,terminal]
----
terraform destroy
----

After the command is complete, your resources are deleted.

[NOTE]
====
If you manually delete a resource, you create unresolvable issues within your environment.
====